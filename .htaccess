# Proteção contra listagem de diretórios
Options -Indexes

# Ativar Rewrite Engine
RewriteEngine On

# Força HTTPS mantendo query string
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,QSA]

# Proteção de Arquivos Sensíveis
<FilesMatch "\.(env|sql|log|json)$">
    Require all denied
</FilesMatch>

# ====================================
# SISTEMA DE CACHE AVANÇADO
# ====================================

<IfModule mod_headers.c>
    # Remove ETags (versionamento é mais eficiente)
    Header unset ETag
    FileETag None
    
    # Adiciona vary para compressão
    Header append Vary Accept-Encoding
    
    # HTML, XML, TXT - Sem Cache (conteúdo dinâmico)
    <FilesMatch "\.(html|htm|xml|txt|xsl)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # CSS e JavaScript - Cache longo (1 ano) com versionamento
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
    </FilesMatch>
    
    # Imagens - Cache longo (1 ano)
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|svg|webp|avif|bmp)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
    </FilesMatch>
    
    # Fontes - Cache longo (1 ano) com CORS
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
    
    # Vídeos e Áudio - Cache médio (30 dias)
    <FilesMatch "\.(mp4|webm|ogg|ogv|mp3|wav|flac|aac|m4a)$">
        Header set Cache-Control "public, max-age=2592000"
        Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
    </FilesMatch>
    
    # PDF e Documentos - Cache moderado (1 semana)
    <FilesMatch "\.(pdf|doc|docx|xls|xlsx|ppt|pptx)$">
        Header set Cache-Control "public, max-age=604800"
    </FilesMatch>
    
    # PHP - Sem Cache (processamento dinâmico)
    <FilesMatch "\.(php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ====================================
# COMPRESSÃO GZIP
# ====================================

<IfModule mod_deflate.c>
    # Compressão para tipos de texto
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/eot
    
    # Não comprimir arquivos já comprimidos
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|rar|bz2|7z)$ no-gzip
    
    # Não comprimir para navegadores antigos bugados
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# ====================================
# COMPRESSÃO BROTLI (se disponível - mais eficiente que Gzip)
# ====================================

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html
    AddOutputFilterByType BROTLI_COMPRESS text/plain
    AddOutputFilterByType BROTLI_COMPRESS text/xml
    AddOutputFilterByType BROTLI_COMPRESS text/css
    AddOutputFilterByType BROTLI_COMPRESS text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/xml
    AddOutputFilterByType BROTLI_COMPRESS application/xhtml+xml
    AddOutputFilterByType BROTLI_COMPRESS application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS application/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/x-javascript
    AddOutputFilterByType BROTLI_COMPRESS application/json
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# ====================================
# OTIMIZAÇÕES DE PERFORMANCE
# ====================================

# Habilitar Keep-Alive para múltiplas requisições na mesma conexão
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# Prefetch DNS para recursos externos
<IfModule mod_headers.c>
    <FilesMatch "\.(html|php)$">
        Header add Link "<https://fonts.googleapis.com>; rel=dns-prefetch"
        Header add Link "<https://fonts.gstatic.com>; rel=dns-prefetch"
        Header add Link "<https://kit.fontawesome.com>; rel=dns-prefetch"
    </FilesMatch>
</IfModule>
